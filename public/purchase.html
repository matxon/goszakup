<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Поступление товара</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body style="background-color: #0e0d0ddc; color: white;">
<div class="container">
    <h1 class="text-center">Поступление товара</h1>
    <form action="">
        <fieldset>
            <div class="row gx-1 mb-3">
                <label for="" class="form-label col-form-label col col-sm-2 text-start">Номер покупки</label>
                <div class="col col-sm-3">
                    <input id="id" type="text" class="form-control" disabled>
                </div>
            </div>
            <div class="row gx-1 mb-3">
                <label for="" class="form-label col-form-label col-2 col-sm-2 text-start">Дата</label>
                <div class="col-4 col-sm-3">
                    <input id="date" type="date" class="form-control">
                </div>
                <label for="" class="form-label col-form-label col-2 offset-sm-2 text-center">Сумма</label>
                <div class="col-4 col-sm-3">
                    <input type="number" class="form-control text-end" id="summ" disabled>
                </div>
            </div>
            <!-- <pre>
            TODO: 
            1. іздеген кезде БИН сосын Поставщиктің аты, осы екеінің ішінен ізделу керек
            2. Таңдаған кезде аты мен коды таңдалады, сосын select-тің value=id, option = name жазылады
            3. мышкамен 2 рет басқанда Поставщикті енгізетін форма ашылуы керек
            </pre> -->
            <div class="row gx-1 mb-3">
                <label for="" class="form-label col-form-label col-2 text-start">Поставщик</label>
                <div class="col-10">
                    <!-- <select id="supplier9" class="form-control d-none">
                        <option selected value=""></option>
                    </select> -->
                    <div class="input-group">
                        <input type="text" id="id_counter" class="d-none">
                        <input type="text" name="counteragent" id="counteragents" class="form-control" value="" autocomplete="false">
                        <button class="btn btn-secondary" type="button"  id="addcounteragent">+</button>
                    </div>
                    
                    <div class="result-box astable counter d-none">
                        <table class="table table-hover ">
                            <!-- <thead>
                                <tr class="text-center">
                                    <th>Код</th>
                                    <th>Контрагент</th>
                                </tr>
                            </thead> -->
                            <tbody>
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- <pre>
            TODO:    
            input-тардан жасаған дұрыс болмайды, таблицаға ауыстырып
            сосын енгізетін форма арқылы енгізген дұрыс болады-ау деймін
            Формада таңдайтын checkbox салып қойсам, сосын сол таңдалғандардың бәрін
            осы жерге бәрін бір-ақ енгізу қажет 
            </pre> -->
            <!-- <div class="border border-secondary border-3"> -->
                <table class="table table-sm gx-0 products" id="products">
                    <thead class="table-dark">
                        <tr class="text-center">
                            <th style="width: 8%;">Код</th>
                            <th>Наименование товара</th>
                            <th style="width: 8%;">Ед.изм</th>
                            <th style="width: 9%;">Кол-во</th>
                            <th style="width: 10%;">Цена</th>
                            <th style="width: 10%;">Сумма</th>
                            <th style="width: 10px;">+</th>
                            <th style="width: 10px;">-</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input name="id_product" class="astable form-control form-control-sm" type="text" id="" disabled></td>
                            <td><input name="product" class="astable form-control form-control-sm" type="text" id=""></td>
                            <td><input name="unit" class="astable form-control form-control-sm text-center" type="text" id="" disabled></td>
                            <td><input name="calc" class="astable form-control form-control-sm text-end" type="text" id=""></td>
                            <td><input name="calc" class="astable form-control form-control-sm text-end" type="text" id=""></td>
                            <td><input name="equal" class="astable form-control form-control-sm text-end" type="text" id="" disabled></td>
                            <td name="plus" class="text-center">+</td>
                            <td name="" class="text-center">-</td>
                        </tr>
                    </tbody>
                </table>
                
            <!-- </div> -->
            <div class="row m-3 text-end">
                <div class="offset-md-7 col-md-5 offset-sm-6 col-sm-6">
                    <button id="addproduct" type="button" class="btn btn-primary">Добавить товар</button>
                    <button type="button" class="btn btn-primary">Сохранить</button>
                    <button type="button" class="btn btn-primary">Отменить</button>
                </div>
            </div>
        </fieldset>
    </form>
</div>

<div class="modal fade" id="addCounteragentModal" tabindex="-1" aria-labelledby="exampleModalXlLabel" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="exampleModalXlLabel">Добавление контрагента</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="addCounter" method="post">
                    <fieldset>
                        <div class="row gx-1 mb-3">
                            <label for="" class="form-label col-form-label col col-sm-2 text-start">БИН / ИИН</label>
                            <div class="col col-sm-3">
                                <input id="bin" type="text" class="form-control" name="bin">
                            </div>
                            <div class="col-sm-3">
                                <button class="btn btn-primary" id="paste_data" type="button">Вставить данные Контрагента</button>
                            </div>
                        </div>
                        <div class="row gx-1 mb-3">
                            <label for="" class="form-label col-form-label col-2 text-start">Контрагент</label>
                            <div class="col-10">
                                <input id="counteragent" type="text" class="form-control" name="counter">
                            </div>
                        </div>
                        <div class="row gx-1 mb-3">
                            <label for="" class="form-label col-form-label col-2 col-sm-2 text-start">Адрес</label>
                            <div class="col-10">
                                <input type="text" class="form-control" id="address" name="address">
                            </div>
                        </div>
                        <div class="row gx-1 mb-3">
                            <label for="" class="form-label col-form-label col-2">Телефон</label>
                            <div class="col col-md-6 col-sm-10">
                                <input type="text" class="form-control" id="tel" name="tel">
                            </div>
                        </div>
                        <div class="row gx-1 mb-3">
                            <label for="" class="form-label col-form-label col-2">Контактное лицо</label>
                            <div class="col col-md-6 col-sm-10">
                                <input type="text" class="form-control" id="contact" name="contact">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="save">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title" id="addProductModalLabel">Добавление товара</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="addProduct" method="post">
                    <fieldset>
                        <div class="row gx-1 mb-3">
                            <label for="id_product" class="form-label col-form-label col col-sm-2 text-start">Код</label>
                            <div class="col col-sm-3">
                                <input id="id_product" type="text" class="form-control" name="" disabled>
                            </div>
                        </div>
                        <div class="row gx-1 mb-3">
                            <label for="product" class="form-label col-form-label col-2 text-start">Наименование</label>
                            <div class="col-10">
                                <input id="product" type="text" class="form-control" name="">
                            </div>
                        </div>
                        <div class="row gx-1 mb-3">
                            <label for="unit" class="form-label col-form-label col-2 col-sm-2 text-start">Ед.измерения</label>
                            <div class="col-2">
                                <input type="text" class="form-control" id="unit" name="">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="save">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>
<!-- context table for choice -->
<div class="result-box astable free d-none">
    <table class="table table-hover">
        <tbody>
            <tr>
                
            </tr>
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="js/autocomplete.js"></script>
<script>
    $(document).ready( function() {

        // Госзакупкіден копировать етіп алынған
        // мәліметтерді жылдам енгізу
        $('#paste_data').on('click', function() {
            navigator.clipboard
                .readText()
                .then( function(text) {
                    console.log(text);
                    arr = text.split('\t');
                    $('#bin').val(arr[0]);
                    $('#counteragent').val(arr[1]);
                    $('#address').val(arr[2]);
                    $('#tel').val(arr[3]);
                    $('#contact').val(arr[4]);
                });
        });

        
        // Модалды форма ашу
        $('#addcounteragent').on('click', function() {
            // Контрагентті қосуға арналған модалды форма
            myModal = new bootstrap.Modal('#addCounteragentModal');
            myModal.show();
        });

        // Модалды формада жазылған мәліметтерді
        // сервердегі базаға жазуға арналған
        // функция, Button-ды басқанда шақырылады
        $('#addCounter').on('submit', function(event) {
            event.preventDefault();
            const data = {
                bin: $('#bin').val(),
                counteragent: $('#counteragent').val(),
                address: $('#address').val(),
                tel: $('#tel').val(),
                contact: $('#contact').val(),
            }

            $.ajax({
                url: '/saveCounter',
                type: 'post',
                data: data,
                success: function(res) {
                    console.log(res);
                    //myModal.dispose();
                    myModal.hide();
                },
                error: function(err) {
                    console.error(err);
                }
            })
        });

        // Базаға жазатын функцияны шақыру
        $('#save').on('click', function() {
            form = $('#addCounter').trigger('submit', function() {   
            })

        })

        // тауарды енгізген кезде көрінетін контексті
        // таблицаға reference
        ct_table = $('.result-box.astable.free:first');

        // global айнымалысына жазып қойдым, қайта қарастыру керек болар
        window.current;

        $('#products').on('focus', 'input.astable', function() {
            // visible таблицы
            // ct_table.removeClass('d-none');
            // перемещение таблицы
            $(this).after(ct_table);
            // автовыделение текста
            $(this).select();
        })

        $('input.astable').on('blur', function() {
            // console.log(this);
            // ct_table.addClass('d-none');
        })

        $('#products').on('input', 'input[name="product"]', function(e) {
            current = $(this);
            ct_table.removeClass('d-none');
            $(this).after(ct_table);

            var s = e.target.value;
            var result = ct_table;
            var tbody = $('.result-box.free:first tbody');

            if (s.length > 2) {
                $.post('/products', {"str": s.trim() }, 
                    function(data) {
                        console.log(data);
                        // data: объекттерден тұратын массив
                        s = "";
                    
                        data.forEach(element => {
                            // s = s + "<tr><td>" + element.id + '</td><td>' + element.Short_name + "</td></tr>";
                            s = s + "<tr><td>" + element.id + '</td><td>' + element.Product_name + "</td><td>" +
                                element.Unit + "</td><td>" + element.Receipt + "</td><td>" + element.Trade + "</td></tr>";
                        });

                        //s = s + "</ul>"

                        result.removeClass('d-none')
                        tbody.html(s);
                    }
                );
            } else {
                result.addClass('d-none');
            }

        })

        ct_table.on('click', 'tr', function() {
            row = current.parent().parent();
            console.log(row);
            inputs = row.find('input');
            console.log(inputs);
            $(inputs[0]).val($(this).find('td')[0].innerText);
            $(inputs[1]).val($(this).find('td')[1].innerText);
            $(inputs[2]).val($(this).find('td')[2].innerText);
            $(inputs[5]).val($(inputs[3]).val() * $(inputs[4]).val());
            
            ct_table.addClass('d-none');
            $('#summ').val(summ());
        })

        $('#products').on('input', 'input[name="calc"]', function(e) {
            //current = $(this);
            //ct_table.removeClass('d-none');
            //$(this).after(ct_table);
            row = $(this).parent().parent();
            //console.log(row);
            inputs = row.find('input[name="calc"]');
            equal = row.find('input[name="equal"]');
            // console.log(inputs);
            
            $(equal[0]).val($(inputs[0]).val() * $(inputs[1]).val());
            $('#summ').val(summ());
        });

        trow = '<tr><td><input name="id_products" class="astable form-control form-control-sm" type="text" id="" disabled></td><td><input name="product" class="astable form-control form-control-sm" type="text" id=""></td><td><input name="unit" class="astable form-control form-control-sm text-center" type="text" id=""disabled></td><td><input name="calc" class="astable form-control form-control-sm text-end" type="text" id=""></td><td><input name="calc" class="astable form-control form-control-sm text-end" type="text" id=""></td><td><input name="equal" class="astable form-control form-control-sm text-end" type="text" id=""disabled></td><td name="plus" class="text-center">+</td><td name="minus" class="text-center">-</td></tr>';

        $('#products').on('click', 'td[name="plus"]', function(e) {
            $(this).parent().after(trow);
        })

        $('#products').on('click', 'td[name="minus"]', function(e) {
            $(this).parent().remove();
        })

        // Бағаналардағы сандардың қосындысын есептеу
        function summ() {
            equals = $('#products').find('input[name="equal"]');
            s = 0;

            console.log(equals);
            for (a of equals) {
                s += Number($(a).val());
            }

            return s;
        }


        // Жаңа тауарды серверге енгізу формасын ашу
        // бірінші button-ға event жазамыз
        $('#addproduct').on('click', function() {
            // модалды форма ашамыз
            myModal = new bootstrap.Modal('#addProductModal');
            myModal.show();

        })

    });

    

   
</script>
</body>
</html>